use strict;
use warnings;
use Test::More;
use English qw(-no_match_vars);

return plan skip_all => 'Set TEST_USER and TEST_PASSWORD to access a mailbox for these tests' unless $ENV{TEST_USER} and $ENV{TEST_PASSWORD};

eval "use Test::WWW::Mechanize::Catalyst 'CiderWebmail'";
if ($@) {
    plan skip_all => 'Test::WWW::Mechanize::Catalyst required';
    exit;
}

my $uname = getpwuid $UID;

ok( my $mech = Test::WWW::Mechanize::Catalyst->new, 'Created mech object' );

$mech->get_ok( 'http://localhost/' );
$mech->submit_form_ok({ with_fields => { username => $ENV{TEST_USER}, password => $ENV{TEST_PASSWORD} } });

$mech->get_ok('http://localhost/mailboxes');

if($mech->content =~ m/<span class="name">Sent<\/span>/) {
    done_testing();
    exit;
} else {
    $mech->get_ok('http://localhost/create_folder');

    $mech->submit_form_ok({
        with_fields => {
            name => 'Sent',
        },
    });

}

$mech->get_ok('http://localhost/mailboxes');
$mech->content_contains('<span class="name">Sent</span>', 'verify new sent folder') or die "\n\nXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX\nYOU DO NOT HAVE A SEND FOLDER, AND THIS TEST WAS UNABLE TO CREATE IT. OTHER TESTS WILL FAIL BECAUSE OF THIS\nXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX\n\n";

done_testing();
